<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Advanced Flight Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+tdDEIP6XW8oHnSyTjWNY/sLhWyXnR8lGYe3oRrF0=" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-pvG5DwKBOI0i+YAkn8DQaY9ZVUZE+wSP1srbVW/ticA=" crossorigin=""></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #map { height: 400px; margin-bottom: 20px; }
    .controls { margin-bottom: 10px; }
    .flight-list { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
    .flight-item { cursor: pointer; padding: 4px; border-bottom: 1px solid #eee; }
    .flight-item:hover { background: #f0f0f0; }
  </style>
</head>
<body>
  <h1>Advanced Flight Tracker</h1>
  <div class="controls">
    <label for="state-select">State:</label>
    <select id="state-select">
      <option value="">--Select a state--</option>
      <option value="37,-114,42,-109">Utah</option>
      <option value="37,-109,41,-102">Colorado</option>
      <option value="31.33,-114.82,37,-109">Arizona</option>
    </select>
    <button onclick="searchRegion()">Search</button>
    <input id="callsign-input" placeholder="Track callsign (e.g. SWA3275)" />
    <button onclick="trackCallsign()">Track</button>
  </div>
  <div id="map"></div>
  <div id="flight-list" class="flight-list"></div>
  <script>
    const map = L.map('map').setView([39.5, -98.35], 4);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    let markers = [];
    function clearMarkers() {
      markers.forEach(marker => map.removeLayer(marker));
      markers = [];
    }
    function addMarker(flight) {
      const marker = L.marker([flight.latitude, flight.longitude]).addTo(map);
      marker.bindPopup(`<b>${flight.callsign || flight.icao24}</b><br>Altitude: ${flight.altitude}<br>Origin: ${flight.origin_country}`);
      markers.push(marker);
    }
    async function searchRegion() {
      const val = document.getElementById('state-select').value;
      if (!val) {
        alert('Select a state first.'); return;
      }
      const [lamin, lomin, lamax, lomax] = val.split(',').map(Number);
      const res = await fetch(`/region?lamin=${lamin}&lomin=${lomin}&lamax=${lamax}&lomax=${lomax}`);
      const flights = await res.json();
      clearMarkers();
      const listDiv = document.getElementById('flight-list');
      listDiv.innerHTML = '';
      flights.forEach(f => {
        addMarker(f);
        const item = document.createElement('div');
        item.className = 'flight-item';
        item.textContent = f.callsign || f.icao24;
        item.onclick = () => trackFlight(f.callsign || f.icao24);
        listDiv.appendChild(item);
      });
      if (flights.length) {
        const first = flights[0];
        map.setView([first.latitude, first.longitude], 6);
      }
    }
    async function trackFlight(callsign) {
      if (!callsign) return;
      const res = await fetch(`/track?callsign=${callsign}`);
      const data = await res.json();
      alert(JSON.stringify(data, null, 2));
    }
    async function trackCallsign() {
      const callsign = document.getElementById('callsign-input').value.trim();
      if (callsign) {
        trackFlight(callsign);
      }
    }
  </script>
</body>
</html>
